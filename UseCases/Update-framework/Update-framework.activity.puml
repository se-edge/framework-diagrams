@startuml
legend top left
ðŸ—² is a system telemetry
endlegend

start
-> Twin update;
:ðŸ—² Framework update in progress;
if (Pull New EdgeManager image) then (ok)
    ' If it fails we assume there is no edge updater on target
    : Remove all EdgeUpdater images;
    if (Pull EdgeUpdater image) then (ok)
        if (Run EdgeUpdater image) then (ok)
            partition EdgeUpdater {
                ' Preflight checks
                if (EdgeManager container exist and a new image is present localy) then (ok)
                    :Stop edgemanager;
                    if (Backup edgemanager database) then (ok)
                        ' If this one fails we assume there is no EM already present
                        :Remove oldedgemanager container if exists;
                        if(Rename edgemanager container to oldedgemanager) then (ok)
                            if (Create edgemanager container with the new image) then (ok)
                                if (Start edgemanager) then (ok)
                                    if(Edge Manager reaches healthy state) then (ok)
                                        ' No error handling here, we are done, it's best effort mode
                                        :Remove oldedgemanager container, DB backup & image;
                                        stop
                                        note right
                                        The edge framework is up to date
                                        end note
                                    else
                                        if(rename oldedgemanager container to edgemanager) then (ok)
                                            ' No error handling here, we are done, it's best effort mode
                                            :Restore DB;
                                            :Remove oldedgemanager container, DB backup & image;
                                            if(Restart Edge Manager with error as parameter) then (ok)
                                                end
                                                note right
                                                Update failed.
                                                The Edge Manager will send [ðŸ—² Framework update failed] after its restart.
                                                end note
                                            else
                                                end
                                                note left
                                                The device is bricked.
                                                end note
                                            endif
                                        else
                                            end
                                            note left
                                            The device is bricked.
                                            end note
                                        endif
                                    endif
                                else
                                    if(rename oldedgemanager container to edgemanager) then (ok)
                                        ' No error handling here, we are done, it's best effort mode
                                        :Restore DB;
                                        :Remove oldedgemanager container, DB backup & image;
                                        if(Restart Edge Manager with error as parameter) then (ok)
                                            end
                                            note right
                                            Update failed.
                                            The Edge Manager will send [ðŸ—² Framework update failed] after its restart.
                                            end note
                                        else
                                            end
                                            note left
                                            The device is bricked.
                                            end note
                                        endif
                                    else
                                        end
                                        note left
                                        The device is bricked.
                                        end note
                                    endif
                                endif
                            else
                                if(Rename oldedgemanager container to edgemanager) then (ok)
                                    ' No error handling here, we are done, it's best effort mode
                                    :Restore DB;
                                    :Remove oldedgemanager container, DB backup & image;
                                    if(Restart Edge Manager with error as parameter) then (ok)
                                        end
                                        note right
                                        Update failed.
                                        The Edge Manager will send [ðŸ—² Framework update failed] after its restart.
                                        end note
                                    else
                                        end
                                        note left
                                        The device is bricked.
                                        end note
                                    endif
                                else
                                    end
                                    note left
                                    The device is bricked.
                                    end note
                                endif
                            endif
                        else
                            :Restore DB;
                            if(Restart Edge Manager with error as parameter) then (ok)
                                end
                                note right
                                Update failed.
                                The Edge Manager will send [ðŸ—² Framework update failed] after its restart.
                                end note
                            else
                                end
                                note left
                                The device is bricked.
                                end note
                            endif
                        endif
                    else
                        if(Restart Edge Manager with error as parameter) then (ok)
                            end
                            note right
                            Update failed.
                            The Edge Manager will send [ðŸ—² Framework update failed] after its restart.
                            end note
                        else
                            end
                            note left
                            The device is bricked.
                            end note
                        endif
                    endif
                else
                    if(Restart Edge Manager with error as parameter) then (ok)
                        end
                        note right
                        Update failed.
                        The Edge Manager will send [ðŸ—² Framework update failed] after its restart.
                        end note
                    else
                        end
                        note right
                        The device is bricked.
                        end note
                    endif
                endif
            }
        else
            :ðŸ—² Framework update failed;
            end
        endif
    else
        :ðŸ—² Framework update failed;
        end
    endif
else
    :ðŸ—² Framework update failed;
    end
endif
@enduml
